import requests  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
import sys       # –î–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
from typing import Tuple, Dict, Any  # –¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞
from datetime import datetime, timezone, timedelta  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º


API_KEY = "13ff878c18f67d9be7da4fd7ffc3b90f"  # –ö–ª—é—á API OpenWeatherMap


def get_location() -> Tuple[str, float, float]:
    """–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ IP"""
    try:
        resp = requests.get("https://ipinfo.io/json", timeout=5)  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
        resp.raise_for_status()  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        data = resp.json()  # –ü–∞—Ä—Å–∏–º JSON
        city = data.get("city", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")  # –ë–µ—Ä—ë–º –≥–æ—Ä–æ–¥ –∏–ª–∏ "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        loc = data.get("loc")  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        if not loc:  # –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç
            raise ValueError("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")  # –û—à–∏–±–∫–∞
        lat, lon = map(float, loc.split(","))  # –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ float
        return city, lat, lon  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–æ–¥, —à–∏—Ä–æ—Ç—É –∏ –¥–æ–ª–≥–æ—Ç—É
    except Exception as e:  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫
        print(f"[–û—à–∏–±–∫–∞] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é: {e}")  # –í—ã–≤–æ–¥ –æ—à–∏–±–∫–∏
        sys.exit(1)  # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É


def get_weather(lat: float, lon: float) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º"""
    url = (
        f"http://api.openweathermap.org/data/2.5/weather?"
        f"lat={lat}&lon={lon}&appid={API_KEY}&units=metric&lang=ru"
    )  # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    try:
        resp = requests.get(url, timeout=7)  # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        resp.raise_for_status()  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        return resp.json()  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º JSON —Å –ø–æ–≥–æ–¥–æ–π
    except requests.HTTPError:  # –ï—Å–ª–∏ HTTP –æ—à–∏–±–∫–∞
        print(f"[–û—à–∏–±–∫–∞ HTTP] –°—Ç–∞—Ç—É—Å: {resp.status_code} - {resp.text}")  # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å –∏ —Ç–µ–∫—Å—Ç
        sys.exit(1)  # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
    except requests.RequestException as e:  # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        print(f"[–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞] {e}")  # –í—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
        sys.exit(1)  # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É


def format_time(unix_timestamp: int, tz_offset: int) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ UNIX-–≤—Ä–µ–º–µ–Ω–∏ –≤ —Å—Ç—Ä–æ–∫—É —Å —É—á—ë—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞"""
    local_tz = timezone(timedelta(seconds=tz_offset))  # –°–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω—ã–π timezone
    dt_local = datetime.fromtimestamp(unix_timestamp, tz=timezone.utc).astimezone(local_tz)  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
    return dt_local.strftime("%Y-%m-%d %H:%M:%S")  # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É


def weather_ascii(icon: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∫–æ–¥—É –∏–∫–æ–Ω–∫–∏ –ø–æ–≥–æ–¥—ã"""
    icons = {
        "01d": "‚òÄÔ∏è  –Ø—Å–Ω–æ", "01n": "üåô  –Ø—Å–Ω–æ –Ω–æ—á—å—é",
        "02d": "‚õÖ  –ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ", "02n": "‚òÅÔ∏è  –ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ –Ω–æ—á—å—é",
        "03d": "‚òÅÔ∏è  –û–±–ª–∞—á–Ω–æ", "03n": "‚òÅÔ∏è  –û–±–ª–∞—á–Ω–æ –Ω–æ—á—å—é",
        "04d": "‚òÅÔ∏è‚òÅÔ∏è  –ü–∞—Å–º—É—Ä–Ω–æ", "04n": "‚òÅÔ∏è‚òÅÔ∏è  –ü–∞—Å–º—É—Ä–Ω–æ –Ω–æ—á—å—é",
        "09d": "üåßÔ∏è  –õ–∏–≤–µ–Ω—å", "09n": "üåßÔ∏è  –õ–∏–≤–µ–Ω—å –Ω–æ—á—å—é",
        "10d": "üå¶Ô∏è  –î–æ–∂–¥—å", "10n": "üå¶Ô∏è  –î–æ–∂–¥—å –Ω–æ—á—å—é",
        "11d": "‚õàÔ∏è  –ì—Ä–æ–∑–∞", "11n": "‚õàÔ∏è  –ì—Ä–æ–∑–∞ –Ω–æ—á—å—é",
        "13d": "‚ùÑÔ∏è  –°–Ω–µ–≥", "13n": "‚ùÑÔ∏è  –°–Ω–µ–≥ –Ω–æ—á—å—é",
        "50d": "üå´Ô∏è  –¢—É–º–∞–Ω", "50n": "üå´Ô∏è  –¢—É–º–∞–Ω –Ω–æ—á—å—é",
    }  # –°–ª–æ–≤–∞—Ä—å –∏–∫–æ–Ω–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–π
    return icons.get(icon, "‚ùì –ü–æ–≥–æ–¥–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞")  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"


def display_weather(data: Dict[str, Any], city: str) -> None:
    """–í—ã–≤–æ–¥–∏—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–≥–æ–¥—É"""
    main = data.get("main", {})  # –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫ main
    weather = data.get("weather", [{}])[0]  # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç weather
    wind = data.get("wind", {})  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Ç—Ä–µ
    sys_info = data.get("sys", {})  # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–æ–ª–Ω—Ü–µ)
    tz_offset = data.get("timezone", 0)  # –°–º–µ—â–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

    print("\n" + "="*40)  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    print(f"üåç –ü–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ: {city}")  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≥–æ—Ä–æ–¥–æ–º
    print("="*40)  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å

    print(weather_ascii(weather.get("icon", "")))  # –í—ã–≤–æ–¥–∏–º ASCII-–∏–∫–æ–Ω–∫—É –ø–æ–≥–æ–¥—ã
    print(f"–û–ø–∏—Å–∞–Ω–∏–µ: {weather.get('description', '').capitalize()}")  # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã

    print(f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {main.get('temp')}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {main.get('feels_like')}¬∞C)")  # –¢–µ–º–ø. –∏ –æ—â—É—â–∞–µ—Ç—Å—è
    print(f"–í–ª–∞–∂–Ω–æ—Å—Ç—å: {main.get('humidity')}%")  # –í–ª–∞–∂–Ω–æ—Å—Ç—å
    print(f"–î–∞–≤–ª–µ–Ω–∏–µ: {main.get('pressure')} –≥–ü–∞")  # –î–∞–≤–ª–µ–Ω–∏–µ

    print(f"–í–µ—Ç–µ—Ä: {wind.get('speed')} –º/—Å, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {wind.get('deg', 0)}¬∞")  # –°–∫–æ—Ä–æ—Å—Ç—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞

    # –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è –≤–æ—Å—Ö–æ–¥–∞ –∏ –∑–∞–∫–∞—Ç–∞ ‚Äî –≤—ã–≤–æ–¥–∏–º –∏—Ö —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    if (sunrise := sys_info.get("sunrise")) and (sunset := sys_info.get("sunset")):
        print(f"–í–æ—Å—Ö–æ–¥ —Å–æ–ª–Ω—Ü–∞: {format_time(sunrise, tz_offset)}")
        print(f"–ó–∞–∫–∞—Ç —Å–æ–ª–Ω—Ü–∞: {format_time(sunset, tz_offset)}")

    print("="*40 + "\n")  # –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º


def main():
    print("–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP... üåê")  # –õ–æ–≥ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    city, lat, lon = get_location()  # –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    print(f"–í–∞—à –≥–æ—Ä–æ–¥: {city} (—à–∏—Ä–æ—Ç–∞: {lat}, –¥–æ–ª–≥–æ—Ç–∞: {lon})")  # –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏

    print("\n–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ... ‚òÅÔ∏è")  # –õ–æ–≥ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–≥–æ–¥—ã
    weather_data = get_weather(lat, lon)  # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É

    display_weather(weather_data, city)  # –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∫—Ä–∞—Å–∏–≤–æ


if __name__ == "__main__":
    main()  # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
